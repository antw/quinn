(function(m,j){function c(a){j.bindAll(this,"start","drag","change","abort");this.options=j.extend({},{target:100,algo:"least_recently_used"},a);if(c.algo.hasOwnProperty(this.options.algo))this.algo=c.algo[this.options.algo];else throw"No such balancing algorithm: "+this.options.algo;this.target=this.options.target;this.precision=1;this.callbacks={};this.members=[];this.subordinates=[];this.order=[];this.oValues=this.masterId=null;this.disabled=false}function f(a){var b;this.length=a.length;this.members=
a;this.values={};for(b=0;b<this.length;b++)this.values[a[b].balanceId]=a[b].model.value}c.prototype.on=m.Quinn.prototype.on;c.prototype.trigger=m.Quinn.prototype.trigger;c.prototype.add=function(a){a.balanceId=j.uniqueId("qbalance.");a.on("begin",this.start);a.on("drag",this.drag);a.on("change",this.change);a.on("abort",this.abort);this.members.push(a);this.order.push(a.balanceId);this.precision=j.max(j.map(this.members,function(a){a=(""+a.model.step).split(".");return a[1]&&a[1].length+1||1}));return this};
c.prototype.doBalance=function(a,b){var d=a-this.oValues.value(b),e;if(Math.abs(d)>this.max)return false;if(this.subordinates.length===0)return false;d=new f(this.subordinates);e=this.oValues.sumOf(this.subordinates)+a;e=this.snap(this.target-e);if(this.algo.call(this,e)!==0)return d.revert(),false};c.prototype.start=function(a,b){if(this.disabled)return true;if(this.masterId===null)this.masterId=b.balanceId,this.subordinates=this.getSubordinates(),this.oValues=new f(this.members),this.callSubordinates("start"),
this.trigger("start")};c.prototype.drag=function(a,b){if(this.isMaster(b)){if(this.doBalance(a,b)===false)return false;this.trigger("change")}};c.prototype.change=function(a,b){this.isMaster(b)&&(this.sliderUsed(b),this.finish("resolve"),this.trigger("change"))};c.prototype.abort=function(a,b){this.isMaster(b)&&(this.finish("reject"),this.trigger("abort"))};c.prototype.getSubordinates=function(){var a=this,b;b=j.select(this.members,function(b){return!a.isMaster(b)&&!b.disabled});return this.members.length<
2?b:j.sortBy(b,function(b){return j.indexOf(a.order,b.balanceId)})};c.prototype.finish=function(a){this.callSubordinates(a);this.oValues=this.subordinates=this.masterId=null};c.prototype.callSubordinates=function(a){var b=this.subordinates.length,d;for(d=0;d<b;d++)this.subordinates[d][a]()};c.prototype.snap=function(a){var b=Math.pow(10,this.precision);return Math.round(a*b)/b};c.prototype.isMaster=function(a){return this.masterId!==null&&this.masterId===a.balanceId};c.prototype.sliderUsed=function(a){if(this.members.length<=
2)return true;this.order=j.without(this.order,a.balanceId);this.order.push(a.balanceId)};c.algo={};c.algo.least_recently_used=function(a){var b=this.subordinates.length,d,e,c;for(d=0;d<b;d++)e=this.subordinates[d],c=this.oValues.value(e),e.setTentativeValue(this.snap(c+a),false),a=this.snap(a-(e.model.value-c));return a};c.algo.fair=function(a){var b=20,d=j.clone(this.subordinates),c=d.length,g,n,l,h,k,f,i;for(i=0;i<c;i++)g=d[i],g.balanceDelta=g.model.maximum-g.model.minimum;for(;b--;){n=[];l=a;for(i=
h=0;i<c;i++)h+=d[i].balanceDelta;for(i=0;i<c;i++)g=d[i],k=l*(g.balanceDelta/h),f=b===19?this.oValues.value(g):g.model.value,g.setTentativeValue(f+k,false),a-=g.model.value-f,n.push(g);d=n;c=d.length;if(a===0||a===l)break}return a};c.algo.fair=function(a){for(var b=0,c=j.clone(this.subordinates),e=c.length,g,f,l,h,k;20>=b++;){g=[];for(f=0;f<e;f++)l=this.snap(a/(e-f)),h=c[f],k=h.model.value,b===1&&(k=this.oValues.value(h)),h.setTentativeValue(k+l,false),a=this.snap(a-(h.model.value-k)),(a<0&&h.model.value!==
h.model.minimum||a>0&&h.model.value!==h.model.maximum)&&g.push(h);c=g;e=c.length;if(a===0||void 0===a)break;previousFlex=a}return a};f.prototype.value=function(a){return this.values[a.balanceId]};f.prototype.sumOf=function(a){var b=a.length,c=0,e;for(e=0;e<b;e++)c+=this.value(a[e]);return c};f.prototype.revert=function(){var a,b;for(a=0;a<this.length;a++)b=this.members[a],b.setTentativeValue(this.values[b.balanceId])};m.Quinn.Balancer=c})(jQuery,_);
