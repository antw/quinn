(function(j,d){function b(a){d.bindAll(this,"start","drag","change","abort");this.options=d.extend({},{target:100,algo:"least_recently_used"},a);if(b.algo.hasOwnProperty(this.options.algo))this.algo=b.algo[this.options.algo];else throw"No such balancing algorithm: "+this.options.algo;this.target=this.options.target;this.precision=1;this.callbacks={};this.members=[];this.subordinates=[];this.order=[];this.oValues=this.masterId=null;this.disabled=false}function h(a){var c;this.length=a.length;this.members=
a;this.values={};for(c=0;c<this.length;c++)this.values[a[c].balanceId]=a[c].model.value}b.prototype.on=j.Quinn.prototype.on;b.prototype.trigger=j.Quinn.prototype.trigger;b.prototype.add=function(a){a.balanceId=d.uniqueId("qbalance.");a.on("begin",this.start);a.on("drag",this.drag);a.on("change",this.change);a.on("abort",this.abort);this.members.push(a);this.order.push(a.balanceId);this.precision=d.max(d.map(this.members,function(a){a=(""+a.model.step).split(".");return a[1]&&a[1].length+1||1}));return this};
b.prototype.doBalance=function(a,c){var l=a-this.oValues.value(c),b;if(Math.abs(l)>this.max)return false;if(this.subordinates.length===0)return false;l=new h(this.subordinates);b=this.oValues.sumOf(this.subordinates)+a;b=this.snap(this.target-b);if(this.algo.call(this,b)!==0)return l.revert(),false};b.prototype.start=function(a,c){if(this.disabled)return true;if(this.masterId===null)this.masterId=c.balanceId,this.subordinates=this.getSubordinates(),this.oValues=new h(this.members),this.callSubordinates("start"),
this.trigger("start")};b.prototype.drag=function(a,c){if(this.isMaster(c)){if(this.doBalance(a,c)===false)return false;this.trigger("change")}};b.prototype.change=function(a,c){this.isMaster(c)&&(this.sliderUsed(c),this.finish("resolve"),this.trigger("change"))};b.prototype.abort=function(a,c){this.isMaster(c)&&(this.finish("reject"),this.trigger("abort"))};b.prototype.getSubordinates=function(){var a=this,c;c=d.select(this.members,function(c){return!a.isMaster(c)&&!c.disabled});return this.members.length<
2?c:d.sortBy(c,function(c){return d.indexOf(a.order,c.balanceId)})};b.prototype.finish=function(a){this.callSubordinates(a);this.oValues=this.subordinates=this.masterId=null};b.prototype.callSubordinates=function(a){var c=this.subordinates.length,b;for(b=0;b<c;b++)this.subordinates[b][a]()};b.prototype.snap=function(a){var c=Math.pow(10,this.precision);return Math.round(a*c)/c};b.prototype.isMaster=function(a){return this.masterId!==null&&this.masterId===a.balanceId};b.prototype.sliderUsed=function(a){if(this.members.length<=
2)return true;this.order=d.without(this.order,a.balanceId);this.order.push(a.balanceId)};b.algo={};b.algo.least_recently_used=function(a){var c=this.subordinates.length,b,e,d;for(b=0;b<c;b++)e=this.subordinates[b],d=this.oValues.value(e),e.setTentativeValue(this.snap(d+a),false),a=this.snap(a-(e.model.value-d));return a};b.algo.fair=function(a){for(var c=0,b=d.clone(this.subordinates),e=b.length,h,j,m,k,g,f,i,n;20>=c++;){m=[];j=a;h=0;k=b.length;g=void 0;for(g=0;g<k;g++)h+=b[g].model.max-b[g].model.min;
for(k=0;k<e;k++)f=b[k],i=f.model.value,c===1&&(i=this.oValues.value(f)),g=this.snap(j*((f.model.max-f.model.min)/h)),f.setTentativeValue(i+g,false),i=f.model.value-i,a-=i,i!==g&&(j+=g-i),(a<0&&f.model.value>f.model.min||a>0&&f.model.value<f.model.max)&&m.push(f);b=m;e=b.length;if(a===0||e===0||n===a)break;n=a}return a};h.prototype.value=function(a){return this.values[a.balanceId]};h.prototype.sumOf=function(a){var b=a.length,d=0,e;for(e=0;e<b;e++)d+=this.value(a[e]);return d};h.prototype.revert=function(){var a,
b;for(a=0;a<this.length;a++)b=this.members[a],b.setTentativeValue(this.values[b.balanceId])};j.Quinn.Balancer=b})(jQuery,_);
