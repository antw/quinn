(function(f,d){function b(a,c){d.bindAll(this,"clickBar","startDrag","drag","endDrag");this.wrapper=a;this.options=d.extend({},b.defaults,c);this.callbacks={};this.disabled=false;this.previousValue=this.activeHandle=null;this.model=new i(this);this.renderer=new this.options.renderer(this);this.leftExtent=this.options.range[0];this.rightExtent=this.options.range[1];this.bind("setup",this.options.onSetup);this.bind("begin",this.options.onBegin);this.bind("drag",this.options.onDrag);this.bind("change",
this.options.onChange);this.bind("abort",this.options.onAbort);d.isFunction(this.renderer.render)&&this.renderer.render();this.options.disable===true&&this.disable();this.trigger("setup",this.model.value)}function i(a){var c,e;this.options=a.options;this.values=[];this.previousValues=[];this.step=a.options.step;this.only=a.options.only;a=this.options.selectable||this.options.range;this.minimum=a[0];this.maximum=a[1];c=this.roundToStep(a[0]);e=this.roundToStep(a[1]);c<a[0]&&(c+=this.options.step);
e>a[1]&&(e-=this.options.step);this.minimum=c;this.maximum=e;a=this.options.value==null?this.minimum:d.isArray(this.options.value)?this.options.value:[this.options.value];for(e=0,c=a.length;e<c;e++)this.values[e]=null;this.setValue(a)}var k="mousemove",m="mousedown",l="mouseup",h=false;"ontouchstart"in document.documentElement&&(document.createEvent("TouchEvent"),k="touchmove",m="touchstart",l="touchend",h=true);b.prototype.bind=function(a,c){d.isString(a)&&d.isFunction(c)&&(this.callbacks[a]||(this.callbacks[a]=
[]),this.callbacks[a].push(c));return this};b.prototype.trigger=function(a,c){var e=this.callbacks[a]||[],b,d=0;if(c===void 0)c=this.value;for(;b=e[d++];)if(b(c,this)===false)return false;return true};b.prototype.enable=function(){if(this.disabled)this.disabled=false,this.trigger("enabled")};b.prototype.disable=function(){if(!this.disabled)this.disabled=true,this.trigger("disabled")};b.prototype.setValue=function(a,c,e){this.willChange()&&(this.setTentativeValue(a,c,e)!==false?this.hasChanged():this.abortChange());
return this.model.value};b.prototype.setTentativeValue=function(a,c,e){var b=this.model.value,f,g,j;if(a==null)return false;if(this.model.values.length>1&&d.isNumber(a))if(this.activeHandle!=null)f=this.model.sanitizeValue(a),a=d.clone(this.model.values),g=a[this.activeHandle-1],j=a[this.activeHandle+1],g!=null&&f<=g&&(f=g+this.options.step),j!=null&&f>=j&&(f=j-this.options.step),a[this.activeHandle]=f;else return false;a=this.model.setValue(a);if(a===false||!e&&!this.trigger("drag",a))return this.model.setValue(b),
false;this.trigger("redraw",c);return a};b.prototype.stepUp=function(a){return this.model.values.length>1?this.model.value:this.setValue(this.model.value+this.options.step*(a||1))};b.prototype.stepDown=function(a){return this.stepUp(-(a||1))};b.prototype.willChange=function(){if(this.disabled===true||!this.trigger("begin"))return false;this.previousValue=this.model.value;return true};b.prototype.hasChanged=function(){this.deactivateActiveHandle();if(!this.trigger("change",this.model.value))return this.setTentativeValue(this.previousValue),
this.abortChange(),false;this.previousValue===this.value&&this.abortChange()};b.prototype.abortChange=function(){this.previousValue=null;this.deactivateActiveHandle();return this.trigger("abort")};b.prototype.valueFromMouse=function(a){return this.leftExtent+(this.rightExtent-this.leftExtent)*this.positionFromMouse(a)};b.prototype.positionFromMouse=function(a){var c=this.wrapper.width(),e=this.wrapper.offset().left;return(a<e?0:a>e+c?c:a-e)/c};b.prototype.startDrag=function(a,c){if(!h&&a.which!==
1)return true;if(!c&&!this.willChange())return false;this.activateHandleWithEvent(a);f(document).bind(l+".quinn",this.endDrag).bind(k+".quinn",this.drag).bind("mouseenter.quinn",this.endDrag);return false};b.prototype.drag=function(){var a=event.pageX;if(event.type==="touchmove")a=event.originalEvent.targetTouches[0].pageX;this.setTentativeValue(this.valueFromMouse(a),false);return event.preventDefault()};b.prototype.endDrag=function(a){f(document).unbind(l+".quinn").unbind(k+".quinn").unbind("mouseenter.quinn");
this.hasChanged();return a.preventDefault()};b.prototype.clickBar=function(a){if(!h&&a.which!==1)return true;this.willChange()&&(this.activateHandleWithEvent(a),this.setTentativeValue(this.valueFromMouse(a.pageX)),h?this.hasChanged():this.startDrag(a,true));return a.preventDefault()};b.prototype.activateHandleWithEvent=function(a){var c=a.pageX,e;if(this.activeHandle)return false;if(a.type==="touchmove")c=a.originalEvent.targetTouches[0].pageX;e=this.valueFromMouse(c);a=d.min(this.model.values,function(a){return Math.abs(a-
e)});this.activeHandle=d.indexOf(this.model.values,a);this.trigger("handleOn",this.activeHandle)};b.prototype.deactivateActiveHandle=function(){if(this.activeHandle!=null)this.trigger("handleOff",this.activeHandle),this.activeHandle=null};i.prototype.setValue=function(a){var c=this.values,e,b,a=d.isArray(a)?d.clone(a):[a];for(b=0,e=a.length;b<e;b++)a[b]=this.sanitizeValue(a[b]);if(d.isEqual(a,c))return false;this.value=this.values=a;if(this.values.length===1)this.value=a[0];return this.value};i.prototype.roundToStep=
function(a){var c=1/this.step,c=Math.round(a*c)/c;d.isArray(this.only)&&(c=d.min(this.only,function(c){return Math.abs(c-a)}));if(c>this.maximum)return c-this.step;else if(c<this.minimum)return c+this.step;return c};i.prototype.sanitizeValue=function(a){a=this.roundToStep(a);if(a>this.maximum)return this.maximum;else if(a<this.minimum)return this.minimum;return a};b.Renderer=function(a){d.bindAll(this,"render","redraw");this.quinn=a;this.model=a.model;this.wrapper=a.wrapper;this.options=a.options;
this.handles=[];this.drawMin=a.options.range[0];this.drawMax=a.options.range[1];this.activeHandle=null;a.bind("redraw",this.redraw);a.bind("handleOn",d.bind(function(a){this.handles[a].addClass("active")},this));a.bind("handleOff",d.bind(function(a){this.handles[a].removeClass("active")},this))};b.Renderer.prototype.render=function(){function a(a){a.append(f('<div class="left" />'));a.append(f('<div class="main" />'));a.append(f('<div class="right" />'))}var c,b;this.width=this.options.width||this.wrapper.width();
this.bar=f('<div class="bar" />');this.activeBar=f('<div class="active-bar" />');this.model.values.length>1&&this.wrapper.addClass("range");a(this.bar);a(this.activeBar);this.bar.append(this.activeBar);this.wrapper.html(this.bar);this.wrapper.addClass("quinn");for(c=0,b=this.model.values.length;c<b;c++)this.handles[c]=f('<span class="handle"></span>'),this.handles[c].bind(m,this.quinn.startDrag),this.bar.append(this.handles[c]);this.bar.css({width:this.width.toString()+"px"});this.wrapper.bind("mousedown",
this.quinn.clickBar);this.redraw({animate:false})};b.Renderer.prototype.redraw=function(a){var c=this.options,b=this.quinn.leftExtent,f=this.quinn.rightExtent,i=f-b;a==void 0&&(a=true);this.activeBar.stop(true);d.each(this.handles,d.bind(function(g,j){var h;g.stop(true);h=((this.width-5)*((this.model.values[j]-b)/i)).toString()+"px";a&&c.effects?g.animate({left:h},{duration:c.effectSpeed,step:d.bind(function(a){a/=this.width;this.redrawActiveBar(a*(f-b)+b,g);return true},this)}):(g.css("left",h),
this.redrawActiveBar(this.model.value))},this))};b.Renderer.prototype.redrawActiveBar=function(a,c){var b=null,d=null;this.activeBar.stop();this.model.values.length>1?c?c===this.handles[0]?b=this.__positionForValue(a):d=this.__positionForValue(a):(b=this.__positionForValue(a[0]),d=this.__positionForValue(a[1])):a<0?(b=this.__positionForValue(a),d=this.__positionForValue(0)):(b=this.__positionForValue(0),d=this.__positionForValue(a));d=this.bar.width()-d;b!==null&&this.activeBar.css("left",b.toString()+
"px");d!==null&&this.activeBar.css("right",d.toString()+"px")};b.Renderer.prototype.__positionForValue=function(a){a=(a-this.quinn.leftExtent)/(this.quinn.rightExtent-this.quinn.leftExtent)*this.width;return a<0?0:a>this.width?this.width:Math.round(a)};b.defaults={range:[0,100],selectable:null,step:1,value:null,only:null,disable:false,disabledOpacity:0.5,width:null,handleWidth:null,onDrag:null,onChange:null,onSetup:null,renderer:b.Renderer,effectSpeed:"fast",effects:true};f.fn.quinn=function(a){return f.each(this,
function(){new b(f(this),a)})};f.Quinn=b})(jQuery,_);
